<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employee Attendance Portal</title>

  <!-- html2canvas used to generate JPG download on device -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5wZ3zXq4+ZbJgXn1xvB2p1mS2k3gQYwX3qz2m1y1q9/0+UoI8V2zKp1cw5wX1R3lD7k1O4wzI7Yt9G1mBg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    body{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100%;color:#333}
    .container{width:100%;max-width:480px;margin:0 auto;padding:20px;min-height:100%}
    .header{background:#fff;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,.1);text-align:center}
    .header h1{margin:0 0 8px 0;font-size:24px;color:#667eea}
    .search-section,.report-section,.grievance-section{background:#fff;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .search-group{margin-bottom:16px}
    .search-group label{display:block;margin-bottom:8px;font-size:14px;color:#666;font-weight:500}
    input[type="text"], input[type="date"], textarea{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:16px}
    .btn{width:100%;padding:14px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all .2s;margin-bottom:12px}
    .btn-primary{background:#667eea;color:#fff}
    .btn-info{background:#17a2b8;color:#fff}
    .btn-secondary{background:#764ba2;color:#fff}
    .back-btn{background:#6c757d;color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;margin-bottom:16px}
    .message{display:none;padding:12px;border-radius:8px;margin-bottom:16px}
    .message.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .message.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .attendance-item{background:#f8f9fa;border-left:4px solid #667eea;padding:12px;margin-bottom:8px;border-radius:8px}
    .summary-cards{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
    .summary-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:16px;border-radius:12px;text-align:center}
    @media(max-width:480px){.container{padding:12px}.summary-cards{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="app-title">Employee Attendance Portal</h1>
      <p id="company-name">Your Company Name</p>
    </div>

    <div class="search-section" id="searchSection">
      <h2>Search Attendance</h2>

      <!-- Removed display of the actual web app URL per request -->
      <div class="data-source-info" id="dataSourceInfo">üåê Data Source: Google Apps Script Web App</div>

      <div class="search-group">
        <label for="empcode" id="search-label">Enter Employee Code</label>
        <input type="text" id="empcode" placeholder="e.g., EMP001" autocomplete="off"/>
      </div>

      <button class="btn btn-primary" id="searchBtn">View My Attendance</button>
      <button class="btn btn-info" id="fetchDataBtn">Fetch Latest Attendance (from Web App)</button>
      <button class="btn btn-info" id="grievanceBtn">Report Missing / OT</button>
    </div>

    <div class="report-section" id="reportSection" style="display:none">
      <button class="back-btn" id="backBtn">‚Üê Back to Search</button>
      <div class="report-header" id="reportHeader">
        <h2 id="report-company">Your Company Name</h2>
        <div class="emp-info" id="empInfo"></div>
      </div>

      <div class="summary-cards">
        <div class="summary-card">
          <div class="label">Total Present Days</div>
          <div class="value" id="totalPresent">0</div>
        </div>
        <div class="summary-card">
          <div class="label">Total OT Hours</div>
          <div class="value" id="totalOT">0</div>
        </div>
      </div>

      <div class="attendance-list">
        <h3>Attendance Records</h3>
        <div id="attendanceList"></div>
      </div>

      <!-- Download button for individual attendance report -->
      <div style="margin-top:16px">
        <button class="btn btn-secondary" id="downloadBtn">Download Report (JPG)</button>
      </div>
    </div>

    <div class="grievance-section" id="grievanceSection" style="display:none">
      <button class="back-btn" id="backBtn2">‚Üê Back to Search</button>
      <h2>Report Missing Attendance / OT</h2>
      <div class="message" id="grievanceMessage"></div>
      <form id="grievanceForm">
        <div class="form-group">
          <label for="griev-empcode">Employee Code *</label>
          <input type="text" id="griev-empcode" required />
        </div>
        <div class="form-group">
          <label for="griev-empname">Employee Name *</label>
          <input type="text" id="griev-empname" required />
        </div>
        <div class="form-group">
          <label for="griev-date">Date *</label>
          <input type="date" id="griev-date" required />
        </div>
        <div class="form-group">
          <label for="griev-issue">Issue Type *</label>
          <input type="text" id="griev-issue" placeholder="e.g., Missing attendance, Wrong OT hours" required />
        </div>
        <div class="form-group">
          <label for="griev-details">Details *</label>
          <textarea id="griev-details" placeholder="Please describe the issue in detail..." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary" id="submitGrievance">Submit Grievance</button>
      </form>
    </div>
  </div>

  <script>
    /**
     * IMPORTANT:
     * Set WEB_APP_URL to your deployed Google Apps Script Web App URL (the one you get when you deploy "Web app").
     * Example: "https://script.google.com/macros/s/AKfycbx.../exec"
     */
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzq56KQRgnSMQPiqqP_-1XZYolm52m5iEq9EKXfBWfYxNyXCL4DlGjahlAwIjYd0gBy/exec"; // <-- REPLACE with your web app URL

    let externalDataCache = [];

    function showMessage(type, text, targetId = null) {
      const id = targetId || null;
      if (id) {
        const el = document.getElementById(id);
        if (el) { el.className = `message ${type}`; el.textContent = text; el.style.display = 'block'; setTimeout(()=> el.style.display='none',5000); return; }
      }
      const existing = document.querySelector('.search-section .message');
      if (existing) existing.remove();
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      msg.textContent = text;
      msg.style.display = 'block';
      const searchSection = document.getElementById('searchSection');
      searchSection.insertBefore(msg, searchSection.querySelector('.search-group'));
      setTimeout(()=> msg.remove(), 5000);
    }

    async function fetchAllFromWebApp() {
      if (!WEB_APP_URL || WEB_APP_URL.includes('AKfy...')) {
        showMessage('error', 'WEB_APP_URL not configured. Edit the index.html constant WEB_APP_URL and set it to your Apps Script Web App URL.');
        return;
      }

      const btn = document.getElementById('fetchDataBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Fetching...';

      try {
        const res = await fetch(`${WEB_APP_URL}?action=all`);
        if (res.ok) {
          const payload = await res.json();
          externalDataCache = payload.data && Array.isArray(payload.data) ? payload.data : (Array.isArray(payload) ? payload : []);
          showMessage('success', `Fetched ${externalDataCache.length} records from web app.`);
          return;
        }
        throw new Error('Non-OK response, trying JSONP fallback');
      } catch (err) {
        try {
          await new Promise((resolve, reject) => {
            const cb = 'cb_' + Date.now();
            window[cb] = function(response) {
              try {
                externalDataCache = response && response.data ? response.data : (Array.isArray(response) ? response : []);
                showMessage('success', `Fetched ${externalDataCache.length} records via JSONP.`);
                resolve();
              } catch (e) { reject(e); } finally { delete window[cb]; const s = document.getElementById(cb + '_script'); if (s) s.remove(); }
            };
            const script = document.createElement('script');
            script.id = cb + '_script';
            script.src = `${WEB_APP_URL}?action=all&callback=${cb}`;
            script.onerror = function(){ delete window[cb]; script.remove(); reject(new Error('JSONP failed')); };
            document.head.appendChild(script);
          });
        } catch (e) {
          showMessage('error', 'Failed to fetch data from web app: ' + e.message);
        }
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    document.getElementById('searchBtn').addEventListener('click', async () => {
      const empcode = (document.getElementById('empcode').value || '').trim().toUpperCase();
      if (!empcode) { showMessage('error', 'Please enter an employee code'); return; }

      const btn = document.getElementById('searchBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Searching...';

      let results = (externalDataCache || []).filter(r => (r.empcode || '').toString().toUpperCase() === empcode);

      if ((!results || results.length === 0) && WEB_APP_URL && !WEB_APP_URL.includes('AKfy...')) {
        try {
          const res = await fetch(`${WEB_APP_URL}?action=employee&empcode=${encodeURIComponent(empcode)}`);
          if (res.ok) {
            const payload = await res.json();
            results = payload.data || (Array.isArray(payload) ? payload : []);
          } else {
            await new Promise((resolve, reject) => {
              const cb = 'cb_emp_' + Date.now();
              window[cb] = function(response) {
                try {
                  const data = response && response.data ? response.data : (Array.isArray(response) ? response : []);
                  results = data; resolve();
                } catch (e) { reject(e); } finally { delete window[cb]; const s = document.getElementById(cb + '_script'); if (s) s.remove(); }
              };
              const script = document.createElement('script');
              script.id = cb + '_script';
              script.src = `${WEB_APP_URL}?action=employee&empcode=${encodeURIComponent(empcode)}&callback=${cb}`;
              script.onerror = function(){ delete window[cb]; script.remove(); reject(new Error('JSONP failed')); };
              document.head.appendChild(script);
            });
          }
        } catch (e) { console.warn('employee fetch error', e); }
      }

      btn.disabled = false;
      btn.textContent = originalText;

      if (!results || results.length === 0) {
        showMessage('error', 'No attendance records found for this employee code');
        return;
      }

      displayReport(results);
    });

    function displayReport(records) {
      document.getElementById('searchSection').style.display = 'none';
      document.getElementById('reportSection').style.display = 'block';

      const empcode = records[0].empcode || records[0].EMPCODE || '';
      const empname = records[0].empname || records[0].EMPNAME || '';

      document.getElementById('empInfo').innerHTML = `<strong>${empname}</strong> (${empcode})`;

      let totalPresent = records.length;
      let totalOTHours = 0;
      records.forEach(r => {
        const inT = r.in_time || r.IN || r['IN'] || '';
        const outT = r.out_time || r.OUT || r['OUT'] || '';
        totalOTHours += calculateOT(inT, outT);
      });

      document.getElementById('totalPresent').textContent = totalPresent;
      document.getElementById('totalOT').textContent = totalOTHours.toFixed(1);

      const listHtml = records.map(record => {
        const inTime = record.in_time || record.IN || record['IN'] || '';
        const outTime = record.out_time || record.OUT || record['OUT'] || '';
        const otHours = calculateOT(inTime, outTime);
        const shdate = (record.shdate || record.SHDATE || '') || '';
        const shmonth = (record.shmonth || record.SHM || record.SHMONT || '') || '';
        const shyear = (record.shyear || record.SHYEAR || '') || '';
        const formattedDate = `${shdate}/${shmonth}/${shyear}`;
        return `<div class="attendance-item">
                  <div class="date">${formattedDate}</div>
                  <div class="times">
                    <span>üïê IN: ${inTime}</span>
                    <span>üïê OUT: ${outTime}</span>
                  </div>
                  ${otHours>0?`<div style="margin-top:6px;color:#667eea;font-size:13px;font-weight:600;">‚è±Ô∏è OT: ${otHours.toFixed(1)} hours</div>`:''}
                </div>`;
      }).join('');
      document.getElementById('attendanceList').innerHTML = listHtml;

      // Improve auto-download:
      // - Try to auto-generate & download the JPG.
      // - If download is blocked or fails, fallback to opening the image in a new tab and show a helpful message.
      // - Keep the manual Download button available.
      setTimeout(() => {
        autoDownloadReport(`${empcode || 'attendance'}_${(empname||'').replace(/\s+/g,'_') || ''}_${new Date().toISOString().slice(0,10)}.jpg`);
      }, 700);
    }

    function calculateOT(inTime, outTime) {
      if (!inTime || !outTime) return 0;
      const [inH, inM] = (inTime.split(':').map(Number));
      const [outH, outM] = (outTime.split(':').map(Number));
      if (isNaN(inH) || isNaN(outH)) return 0;
      let inMin = inH * 60 + (inM || 0);
      let outMin = outH * 60 + (outM || 0);
      if (outMin < inMin) outMin += 24*60;
      const hours = (outMin - inMin) / 60;
      return Math.max(0, hours - 12);
    }

    async function autoDownloadReport(filename) {
      const reportEl = document.getElementById('reportSection');
      try {
        const canvas = await html2canvas(reportEl, { scale: 2, useCORS: true, logging: false });
        // primary attempt: blob + anchor click (works in most Android/Chrome & modern browsers)
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.92));
        if (blob) {
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.href = url;
          link.download = filename;
          // Append and click to trigger download
          document.body.appendChild(link);
          link.click();
          // Clean up
          setTimeout(() => { URL.revokeObjectURL(url); link.remove(); }, 1500);
          showMessage('success', 'Report download started. If it did not start automatically, tap Download Report (JPG).');
          return true;
        }
        throw new Error('Could not create blob from canvas');
      } catch (err) {
        // fallback: open image in new tab so user can save manually (works on iOS Safari)
        try {
          const canvas = await html2canvas(reportEl, { scale: 1.5, useCORS: true, logging: false });
          const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
          const w = window.open();
          if (w) {
            w.document.write(`<title>Attendance Report</title><img src="${dataUrl}" style="max-width:100%;height:auto;display:block;margin:0 auto"/>`);
            w.document.close();
            showMessage('success', 'Report opened in a new tab. Long-press the image to save it to your device.');
            return true;
          } else {
            showMessage('error', 'Popup blocked. Please use the Download button.');
            return false;
          }
        } catch (e2) {
          showMessage('error', 'Failed to auto-download report: ' + (e2 && e2.message ? e2.message : err.message));
          return false;
        }
      }
    }

    // Download button: explicit/manual download
    document.getElementById('downloadBtn').addEventListener('click', async () => {
      const empInfoText = (document.getElementById('empInfo').textContent || '').replace(/\s+/g, '_');
      const filename = `${empInfoText || 'attendance_report'}_${new Date().toISOString().slice(0,10)}.jpg`;
      try {
        await autoDownloadReport(filename);
      } catch (e) {
        showMessage('error', 'Failed to generate/download report: ' + e.message);
      }
    });

    // Back & grievance UI
    document.getElementById('backBtn').addEventListener('click', () => {
      document.getElementById('reportSection').style.display = 'none';
      document.getElementById('searchSection').style.display = 'block';
    });
    document.getElementById('grievanceBtn').addEventListener('click', () => {
      document.getElementById('searchSection').style.display = 'none';
      document.getElementById('grievanceSection').style.display = 'block';
    });
    document.getElementById('backBtn2').addEventListener('click', () => {
      document.getElementById('grievanceSection').style.display = 'none';
      document.getElementById('searchSection').style.display = 'block';
    });

    // Grievance submit (same pattern as before: try fetch then JSONP)
    document.getElementById('grievanceForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submitGrievance');
      const originalText = btn.textContent;
      btn.disabled = true; btn.textContent = 'Submitting...';
      const grievance = {
        empcode: document.getElementById('griev-empcode').value.trim(),
        empname: document.getElementById('griev-empname').value.trim(),
        date: document.getElementById('griev-date').value,
        issue_type: document.getElementById('griev-issue').value.trim(),
        details: document.getElementById('griev-details').value.trim()
      };
      try {
        if (!WEB_APP_URL || WEB_APP_URL.includes('AKfy...')) {
          showMessage('error', 'WEB_APP_URL not configured. Cannot submit grievance.');
          return;
        }
        try {
          const resp = await fetch(`${WEB_APP_URL}?action=submit_grievance&empcode=${encodeURIComponent(grievance.empcode)}&empname=${encodeURIComponent(grievance.empname)}&date=${encodeURIComponent(grievance.date)}&issue_type=${encodeURIComponent(grievance.issue_type)}&details=${encodeURIComponent(grievance.details)}`);
          if (resp.ok) {
            const payload = await resp.json();
            if (payload.isOk) {
              showMessage('success', 'Grievance submitted successfully!', 'grievanceMessage');
              document.getElementById('grievanceForm').reset();
            } else {
              showMessage('error', 'Failed to submit grievance via web app.');
            }
          } else {
            throw new Error('Non-OK response');
          }
        } catch (err) {
          await new Promise((resolve, reject) => {
            const cb = 'cb_griev_' + Date.now();
            window[cb] = function(response) {
              try {
                if (response && response.isOk) {
                  showMessage('success', 'Grievance submitted successfully!', 'grievanceMessage');
                  document.getElementById('grievanceForm').reset();
                  resolve();
                } else {
                  showMessage('error', 'Failed to submit grievance via web app.', 'grievanceMessage');
                  reject(new Error('submit failed'));
                }
              } catch (e) { reject(e); } finally { delete window[cb]; const s = document.getElementById(cb + '_script'); if (s) s.remove(); }
            };
            const script = document.createElement('script');
            script.id = cb + '_script';
            script.src = `${WEB_APP_URL}?action=submit_grievance&empcode=${encodeURIComponent(grievance.empcode)}&empname=${encodeURIComponent(grievance.empname)}&date=${encodeURIComponent(grievance.date)}&issue_type=${encodeURIComponent(grievance.issue_type)}&details=${encodeURIComponent(grievance.details)}&callback=${cb}`;
            script.onerror = function(){ delete window[cb]; script.remove(); reject(new Error('JSONP failed')); };
            document.head.appendChild(script);
          });
        }
      } catch (e) {
        showMessage('error', 'Failed to submit grievance: ' + e.message, 'grievanceMessage');
      } finally {
        btn.disabled = false; btn.textContent = originalText;
        setTimeout(()=> {
          document.getElementById('grievanceSection').style.display = 'none';
          document.getElementById('searchSection').style.display = 'block';
        }, 1400);
      }
    });

    // Hook fetch button
    document.getElementById('fetchDataBtn').addEventListener('click', fetchAllFromWebApp);

    // Keep the data-source label generic (do not show the raw web app URL)
    (function init() {
      document.getElementById('dataSourceInfo').textContent = `üåê Data Source: Google Apps Script Web App`;
    })();
  </script>
</body>
</html>
